<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phần Mềm Tạo Thời Khóa Biểu</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        :root {
            --primary: #2563eb;
            --primary-light: #60a5fa;
            --primary-dark: #1d4ed8;
            --secondary: #6b7280;
            --accent: #3b82f6;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --background: #ffffff;
            --surface: #ffffff;
            --surface-alt: #f9fafb;
            --text-primary: #1e3a8a;
            --text-secondary: #1e40af;
            --text-muted: #3730a3;
            --border: #e5e7eb;
            --border-light: #f3f4f6;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background: var(--background);
            min-height: 100%;
            color: var(--text-primary);
            font-size: 14px;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .app-wrapper {
            min-height: 100vh;
            padding: 20px;
            background: #f8fafc;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--surface);
            border-radius: var(--radius-xl);
            overflow: hidden;
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--border-light);
        }
        
        .header {
            background: var(--surface);
            color: var(--text-primary);
            padding: 60px 40px;
            text-align: center;
            border-bottom: 1px solid var(--border);
        }
        
        .header-content {
            position: relative;
            z-index: 1;
        }
        
        .header h1 {
            margin: 0 0 16px 0;
            font-size: 2.5rem;
            font-weight: 700;
            letter-spacing: -0.025em;
            line-height: 1.2;
            color: var(--text-primary);
        }
        
        .header p {
            margin: 0;
            opacity: 0.9;
            font-size: 1.1rem;
            font-weight: 400;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .upload-section {
            padding: 80px 60px;
            text-align: center;
            background: var(--surface);
        }
        
        .upload-area {
            border: 2px dashed var(--border);
            border-radius: var(--radius-lg);
            padding: 60px 40px;
            background: var(--surface-alt);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .upload-area:hover {
            border-color: var(--primary);
            background: var(--surface);
            box-shadow: var(--shadow-sm);
        }
        
        .upload-area.dragover {
            border-color: var(--primary);
            background: var(--surface);
            box-shadow: var(--shadow-md);
        }
        
        .upload-area h3 {
            margin: 0 0 12px 0;
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .upload-area p {
            margin: 0 0 32px 0;
            color: var(--text-secondary);
            font-size: 0.95rem;
        }
        
        .file-input {
            display: none;
        }
        
        .upload-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: var(--radius-md);
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .upload-btn:hover {
            background: var(--primary-dark);
        }
        
        .upload-btn:active {
            transform: scale(0.98);
        }
        
        .schedule-container {
            padding: 60px;
            display: none;
            background: var(--surface);
        }
        
        .tabs {
            display: flex;
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: 4px;
            margin-bottom: 48px;
            overflow-x: auto;
            border: 1px solid var(--border);
        }
        
        .tab {
            padding: 12px 20px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.2s ease;
            border-radius: var(--radius-md);
            margin-right: 2px;
            white-space: nowrap;
        }
        
        .tab.active {
            background: var(--primary);
            color: white;
        }
        
        .tab:hover:not(.active) {
            background: var(--surface-alt);
            color: var(--text-primary);
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .controls {
            display: flex;
            gap: 32px;
            margin-bottom: 40px;
            flex-wrap: wrap;
            align-items: end;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-width: 200px;
        }
        
        .control-group label {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.875rem;
            letter-spacing: 0.025em;
        }
        
        .control-group select,
        .control-group input {
            padding: 14px 18px;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            font-size: 0.95rem;
            background: var(--surface);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: inherit;
            box-shadow: var(--shadow-sm);
        }
        
        .control-group select:focus,
        .control-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1), var(--shadow-md);
            transform: translateY(-1px);
        }
        
        .control-group select:hover,
        .control-group input:hover {
            border-color: var(--primary-light);
        }
        
        .search-container {
            position: relative;
        }
        
        .dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            max-height: 240px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            margin-top: 8px;
            box-shadow: var(--shadow-lg);
            backdrop-filter: blur(10px);
        }
        
        .dropdown-item {
            padding: 16px 20px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-light);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 0.9rem;
            color: var(--text-primary);
        }
        
        .dropdown-item:hover {
            background: rgba(37, 99, 235, 0.05);
            color: var(--primary);
            transform: translateX(4px);
        }
        
        .dropdown-item:last-child {
            border-bottom: none;
        }
        
        .student-card, .teacher-card, .room-card {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid var(--border);
            transition: all 0.2s ease;
        }
        
        .student-card:hover, .teacher-card:hover, .room-card:hover {
            box-shadow: var(--shadow-sm);
            border-color: var(--primary);
        }
        
        .student-header, .teacher-header, .room-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .student-info h3, .teacher-info h3, .room-info h3 {
            margin: 0;
            color: var(--text-primary);
            font-size: 1.3rem;
            font-weight: 700;
            letter-spacing: -0.025em;
        }
        
        .student-info p, .teacher-info p, .room-info p {
            margin: 8px 0 0 0;
            color: var(--text-secondary);
            font-size: 0.95rem;
            font-weight: 500;
        }
        
        .schedule-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }
        
        .period-card {
            background: var(--surface-alt);
            padding: 16px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
            transition: all 0.2s ease;
        }
        
        .period-card:hover {
            background: var(--surface);
            border-color: var(--primary);
        }
        
        .period-title {
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 16px;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .period-info {
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }
        
        .period-info strong {
            color: var(--text-primary);
            font-weight: 600;
        }
        
        .teacher-card {
            background: #ffffff;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }
        
        .teacher-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(34, 197, 94, 0.15);
        }
        
        .teacher-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .teacher-info h3 {
            margin: 0;
            color: #0f172a;
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .room-card {
            background: #ffffff;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }
        
        .room-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(168, 85, 247, 0.15);
        }
        
        .room-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .room-info h3 {
            margin: 0;
            color: #0f172a;
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .class-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }
        
        .class-item {
            background: #ffffff;
            padding: 20px;
            border-radius: 16px;
            border: 1px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }
        
        .class-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(14, 165, 233, 0.15);
            border-color: #0ea5e9;
        }
        
        .class-item h4 {
            margin: 0 0 12px 0;
            color: #0f172a;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .class-item p {
            margin: 0;
            color: #6b7280;
            font-size: 0.9rem;
        }
        
        .schedule-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: var(--surface);
            border-radius: var(--radius-lg);
            overflow: hidden;
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow-md);
        }
        
        .schedule-table th {
            background: var(--primary);
            color: white;
            padding: 16px 12px;
            text-align: center;
            font-weight: 500;
            font-size: 0.875rem;
        }
        
        .schedule-table th:first-child {
            border-top-left-radius: var(--radius-lg);
        }
        
        .schedule-table th:last-child {
            border-top-right-radius: var(--radius-lg);
        }
        
        .schedule-table td {
            padding: 16px 14px;
            text-align: center;
            border-bottom: 1px solid var(--border-light);
            vertical-align: middle;
            font-size: 0.85rem;
            transition: all 0.2s ease;
        }
        
        .schedule-table tr:hover {
            background: var(--surface-alt);
        }
        
        .subject-cell {
            background: var(--surface-alt);
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .teacher-cell {
            color: var(--text-secondary);
            font-size: 0.8rem;
            font-weight: 400;
        }
        
        .room-cell {
            color: var(--text-secondary);
            font-size: 0.8rem;
            font-weight: 400;
        }
        
        .class-name {
            font-weight: 500;
            color: var(--primary);
            background: var(--surface-alt);
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            display: inline-block;
        }
        
        .student-name {
            color: var(--text-primary);
            font-weight: 600;
        }
        
        .export-section {
            padding: 60px;
            background: var(--surface-alt);
            text-align: center;
            border-top: 1px solid var(--border-light);
        }
        
        .export-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: var(--radius-md);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            margin: 0 8px 8px 0;
        }
        
        .export-btn:hover {
            background: var(--primary-dark);
        }
        
        .export-btn:active {
            transform: scale(0.98);
        }
        
        /* Pagination Styles */
        .pagination-btn {
            background: var(--surface);
            color: var(--text-primary);
            border: 1px solid var(--border);
            padding: 10px 16px;
            border-radius: var(--radius-md);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            min-width: 80px;
            justify-content: center;
        }
        
        .pagination-btn:hover:not(:disabled) {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: var(--surface-alt);
        }
        
        .pagination-btn:active:not(:disabled) {
            transform: scale(0.98);
        }
        
        .page-number-btn {
            background: var(--surface);
            color: var(--text-primary);
            border: 1px solid var(--border);
            padding: 8px 12px;
            border-radius: var(--radius-sm);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 40px;
            text-align: center;
        }
        
        .page-number-btn:hover {
            background: var(--primary-light);
            color: white;
            border-color: var(--primary-light);
        }
        
        .page-number-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .page-ellipsis {
            color: var(--text-secondary);
            padding: 8px 4px;
            font-weight: 500;
        }
        
        /* Theme Selector Styles */
        .theme-dropdown-container {
            position: relative;
        }
        
        .theme-dropdown-selected {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.05), rgba(96, 165, 250, 0.05));
            border: 2px solid var(--primary-light);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 20px rgba(37, 99, 235, 0.15);
            position: relative;
            overflow: hidden;
        }
        
        .theme-dropdown-selected::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.6s ease;
        }
        
        .theme-dropdown-selected:hover::before {
            left: 100%;
        }
        
        .theme-dropdown-selected:hover {
            border-color: var(--primary);
            box-shadow: 0 8px 30px rgba(37, 99, 235, 0.25);
            transform: translateY(-2px);
        }
        
        .theme-dropdown-selected.open {
            border-color: var(--primary);
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
        }
        
        .theme-color-preview {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .theme-dropdown-selected span {
            flex: 1;
            color: var(--text-primary);
            font-weight: 600;
            font-size: 1rem;
        }
        
        .dropdown-arrow {
            color: var(--text-secondary);
            transition: transform 0.3s ease;
        }
        
        .theme-dropdown-selected.open .dropdown-arrow {
            transform: rotate(180deg);
        }
        
        .theme-dropdown-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--surface);
            border: 2px solid var(--primary);
            border-top: none;
            border-radius: 0 0 var(--radius-lg) var(--radius-lg);
            box-shadow: var(--shadow-xl);
            z-index: 1000;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }
        
        .theme-dropdown-options.open {
            display: block;
            animation: dropdownSlide 0.3s ease-out;
        }
        
        @keyframes dropdownSlide {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .theme-dropdown-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-bottom: 1px solid var(--border-light);
            position: relative;
            overflow: hidden;
        }
        
        .theme-dropdown-option::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(37, 99, 235, 0.1), transparent);
            transition: left 0.4s ease;
        }
        
        .theme-dropdown-option:hover::before {
            left: 100%;
        }
        
        .theme-dropdown-option:last-child {
            border-bottom: none;
        }
        
        .theme-dropdown-option:hover {
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.08), rgba(96, 165, 250, 0.08));
            transform: translateX(8px);
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.15);
        }
        
        .theme-dropdown-option.active {
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.15), rgba(96, 165, 250, 0.15));
            color: var(--primary);
            border-left: 4px solid var(--primary);
        }
        
        .theme-dropdown-option.active::after {
            content: '✓';
            margin-left: auto;
            color: var(--primary);
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .theme-dropdown-option span {
            color: var(--text-primary);
            font-weight: 500;
            font-size: 0.95rem;
        }
        
        .theme-dropdown-option.active span {
            color: var(--primary);
            font-weight: 600;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 32px;
            margin-bottom: 48px;
        }
        
        .stat-card {
            background: var(--surface);
            padding: 32px 24px;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            text-align: center;
            transition: all 0.2s ease;
        }
        
        .stat-card:hover {
            box-shadow: var(--shadow-sm);
            border-color: var(--primary);
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 8px;
            line-height: 1;
        }
        
        .stat-label {
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .stat-detail {
            color: var(--text-muted);
            font-size: 0.9rem;
            line-height: 1.5;
        }
        
        .stat-card.students {
            --accent-color: var(--primary);
            --accent-color-light: var(--primary-light);
        }
        
        .stat-card.classes {
            --accent-color: var(--primary-light);
            --accent-color-light: var(--primary);
        }
        
        .stat-card.subjects {
            --accent-color: var(--accent);
            --accent-color-light: var(--primary-light);
        }
        
        .stat-card.teachers {
            --accent-color: var(--primary-dark);
            --accent-color-light: var(--primary);
        }
        
        .stat-card.rooms {
            --accent-color: var(--primary-light);
            --accent-color-light: var(--accent);
        }
        
        .stat-card.periods {
            --accent-color: var(--accent);
            --accent-color-light: var(--primary-light);
        }
        
        .error-message {
            background: #fef2f2;
            color: var(--error);
            padding: 16px 20px;
            border-radius: var(--radius-md);
            margin: 20px 0;
            border: 1px solid #fecaca;
            font-weight: 400;
        }
        
        .class-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 24px;
            margin-bottom: 40px;
        }
        
        .class-item {
            background: var(--surface);
            padding: 20px;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .class-item:hover {
            box-shadow: var(--shadow-sm);
            border-color: var(--primary);
        }
        
        .class-item h4 {
            margin: 0 0 12px 0;
            color: var(--text-primary);
            font-size: 1.2rem;
            font-weight: 700;
        }
        
        .class-item p {
            margin: 0;
            color: var(--text-secondary);
            font-size: 0.95rem;
            font-weight: 500;
        }
        
        @media (max-width: 768px) {
            .app-wrapper {
                padding: 10px;
            }
            
            .container {
                border-radius: var(--radius-md);
            }
            
            .header {
                padding: 40px 24px;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
            
            .header .header-content > div:first-child {
                flex-direction: column;
                gap: 15px;
                align-items: center;
                text-align: center;
            }
            
            .header .header-content > div:first-child > div {
                flex-direction: column;
                gap: 10px;
                align-items: center;
            }
            
            .theme-dropdown-container {
                max-width: 160px !important;
            }
            
            .theme-dropdown-selected {
                padding: 6px 10px !important;
                font-size: 0.8rem !important;
            }
            
            .theme-color-preview {
                width: 16px !important;
                height: 16px !important;
            }
            
            .upload-section {
                padding: 40px 24px;
            }
            
            .schedule-container {
                padding: 32px 24px;
            }
            
            .schedule-table {
                font-size: 0.75rem;
            }
            
            .schedule-table th,
            .schedule-table td {
                padding: 12px 8px;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
                gap: 20px;
            }
            
            .control-group {
                min-width: auto;
            }
            
            .tabs {
                padding: 6px;
                margin-bottom: 32px;
            }
            
            .tab {
                padding: 12px 16px;
                font-size: 0.85rem;
            }
            
            .stats {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .stat-card {
                padding: 32px 24px;
            }
            
            .stat-number {
                font-size: 2.5rem;
            }
            
            .export-section {
                padding: 40px 24px;
            }
            
            .export-btn {
                display: block;
                width: 100%;
                margin: 0 0 12px 0;
            }
            
            .theme-selector {
                margin-top: 32px;
                padding: 24px 16px;
            }
            
            .theme-dropdown-container {
                max-width: 100%;
            }
            
            .theme-dropdown-selected {
                padding: 14px 16px;
            }
            
            .theme-color-preview {
                width: 20px;
                height: 20px;
            }
            
            .theme-dropdown-selected span {
                font-size: 0.9rem;
            }
            
            .theme-dropdown-option {
                padding: 14px 16px;
            }
            
            .theme-dropdown-option span {
                font-size: 0.85rem;
            }
            
            .pagination-btn {
                padding: 8px 12px;
                min-width: 60px;
                font-size: 0.8rem;
            }
            
            .page-number-btn {
                padding: 6px 10px;
                min-width: 35px;
                font-size: 0.8rem;
            }
            
            #paginationControls {
                gap: 8px;
            }
            
            #pageNumbers {
                gap: 4px;
            }
        }
        
        /* Print Styles */
        @media print {
            body {
                font-size: 12px;
                line-height: 1.4;
                color: #000;
                background: white;
            }
            
            .app-wrapper {
                padding: 0;
                background: white;
            }
            
            .container {
                box-shadow: none;
                border: none;
                border-radius: 0;
                background: white;
            }
            
            .header {
                padding: 20px;
                border-bottom: 2px solid #000;
                background: white;
                color: #000;
            }
            
            .header h1 {
                font-size: 1.8rem;
                color: #000;
                margin-bottom: 10px;
            }
            
            .header p {
                color: #333;
                font-size: 1rem;
            }
            
            .header a {
                display: none;
            }
            
            .theme-selector {
                display: none;
            }
            
            .upload-section {
                display: none;
            }
            
            .tabs {
                display: none;
            }
            
            .controls {
                display: none;
            }
            
            .export-section {
                display: none;
            }
            
            #paginationControls,
            #paginationInfo {
                display: none;
            }
            
            .schedule-table {
                width: 100%;
                border-collapse: collapse;
                margin: 20px 0;
                font-size: 10px;
                border: 1px solid #000;
            }
            
            .schedule-table th,
            .schedule-table td {
                border: 1px solid #000;
                padding: 6px 4px;
                text-align: center;
                background: white;
                color: #000;
            }
            
            .schedule-table th {
                background: #f0f0f0;
                font-weight: bold;
            }
            
            .student-card,
            .teacher-card,
            .room-card {
                border: 1px solid #000;
                margin-bottom: 15px;
                padding: 15px;
                background: white;
                page-break-inside: avoid;
            }
            
            .student-info h3,
            .teacher-info h3,
            .room-info h3 {
                color: #000;
                font-size: 1.1rem;
                margin-bottom: 8px;
            }
            
            .period-card {
                border: 1px solid #ccc;
                margin-bottom: 8px;
                padding: 8px;
                background: #f9f9f9;
            }
            
            .period-title {
                font-weight: bold;
                color: #000;
                margin-bottom: 5px;
            }
            
            .period-info {
                color: #333;
                font-size: 9px;
            }
            
            .stats table {
                border: 1px solid #000;
                width: 100%;
                margin: 20px 0;
            }
            
            .stats th,
            .stats td {
                border: 1px solid #000;
                padding: 8px;
                background: white;
                color: #000;
            }
            
            .stats th {
                background: #f0f0f0;
                font-weight: bold;
            }
            
            .class-name,
            .student-name {
                color: #000;
                background: #f0f0f0;
            }
            
            .subject-cell {
                background: #f9f9f9;
                color: #000;
            }
            
            .teacher-cell,
            .room-cell {
                color: #333;
            }
        }
    </style>
</head>
<body>
    <div class="app-wrapper">
        <div class="container">
            <div class="header">
                <div class="header-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                        <h1 style="margin: 0;">Thời Khóa Biểu Tự Chọn Lớp 12</h1>
                        <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                            <!-- Theme Selector - Compact -->
                            <div class="theme-dropdown-container" style="max-width: 180px;">
                                <div class="theme-dropdown-selected" id="themeDropdownSelected" style="padding: 8px 12px; font-size: 0.9rem;">
                                    <div class="theme-color-preview" style="width: 18px; height: 18px; background: linear-gradient(135deg, #2563eb, #60a5fa);"></div>
                                    <span>Xanh dương</span>
                                    <svg class="dropdown-arrow" width="10" height="6" viewBox="0 0 12 8" fill="none">
                                        <path d="M1 1L6 6L11 1" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </div>
                                <div class="theme-dropdown-options" id="themeDropdownOptions">
                                    <div class="theme-dropdown-option active" data-theme="blue">
                                        <div class="theme-color-preview" style="background: linear-gradient(135deg, #2563eb, #60a5fa);"></div>
                                        <span>Xanh dương</span>
                                    </div>
                                    <div class="theme-dropdown-option" data-theme="green">
                                        <div class="theme-color-preview" style="background: linear-gradient(135deg, #059669, #34d399);"></div>
                                        <span>Xanh lá</span>
                                    </div>
                                    <div class="theme-dropdown-option" data-theme="purple">
                                        <div class="theme-color-preview" style="background: linear-gradient(135deg, #7c3aed, #a78bfa);"></div>
                                        <span>Tím</span>
                                    </div>
                                    <div class="theme-dropdown-option" data-theme="red">
                                        <div class="theme-color-preview" style="background: linear-gradient(135deg, #dc2626, #f87171);"></div>
                                        <span>Đỏ</span>
                                    </div>
                                    <div class="theme-dropdown-option" data-theme="orange">
                                        <div class="theme-color-preview" style="background: linear-gradient(135deg, #ea580c, #fb923c);"></div>
                                        <span>Cam</span>
                                    </div>
                                    <div class="theme-dropdown-option" data-theme="pink">
                                        <div class="theme-color-preview" style="background: linear-gradient(135deg, #db2777, #f472b6);"></div>
                                        <span>Hồng</span>
                                    </div>
                                    <div class="theme-dropdown-option" data-theme="indigo">
                                        <div class="theme-color-preview" style="background: linear-gradient(135deg, #4338ca, #818cf8);"></div>
                                        <span>Chàm</span>
                                    </div>
                                    <div class="theme-dropdown-option" data-theme="teal">
                                        <div class="theme-color-preview" style="background: linear-gradient(135deg, #0d9488, #5eead4);"></div>
                                        <span>Xanh ngọc</span>
                                    </div>
                                </div>
                            </div>
                            <a href="https://tkbnkhoahung.github.io/tkbnk2526hs/" target="_blank" style="background: var(--primary); color: white; padding: 8px 16px; border-radius: var(--radius-md); text-decoration: none; font-weight: 500; transition: all 0.2s ease; display: flex; align-items: center; gap: 6px; font-size: 0.9rem;">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                                    <polyline points="9,22 9,12 15,12 15,22"/>
                                </svg>
                                Trang chủ
                            </a>
                        </div>
                    </div>
                    <p>Áp dụng từ 6/10/2025</p>
                </div>
            </div>
        
        <div class="schedule-container" id="scheduleContainer" style="display: block;">
            <div class="stats" id="stats"></div>
            
            <div class="tabs">
                <button class="tab active" onclick="switchTab('all')">Tổng quan</button>
                <button class="tab" onclick="switchTab('students')">Học sinh</button>
                <button class="tab" onclick="switchTab('teachers')">Giáo viên</button>
                <button class="tab" onclick="switchTab('rooms')">Phòng học</button>
                <button class="tab" onclick="switchTab('classes')">Lớp học</button>
                <button class="tab" onclick="switchTab('codes')">Mã lớp</button>
            </div>
            
            <!-- Tab Tổng quan -->
            <div id="allTab" class="tab-content active">
                <div class="controls">
                    <div class="control-group">
                        <label>Lọc theo lớp:</label>
                        <select id="classFilter">
                            <option value="">Tất cả lớp</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label>Lọc theo tiết:</label>
                        <select id="dayFilter">
                            <option value="">Tất cả tiết</option>
                            <option value="t2">Tiết 2</option>
                            <option value="t3">Tiết 3</option>
                            <option value="t4">Tiết 4</option>
                        </select>
                    </div>
                </div>
                
                <!-- Pagination Info -->
                <div id="paginationInfo" style="margin-bottom: 20px; text-align: center; color: var(--text-secondary); font-size: 0.9rem;"></div>
                
                <div id="scheduleTable"></div>
                
                <!-- Pagination Controls -->
                <div id="paginationControls" style="display: flex; justify-content: center; align-items: center; gap: 15px; margin-top: 30px; flex-wrap: wrap;">
                    <button id="firstPageBtn" class="pagination-btn" onclick="goToPage(1)">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="m11 17-5-5 5-5"/>
                            <path d="m18 17-5-5 5-5"/>
                        </svg>
                        Đầu
                    </button>
                    <button id="prevPageBtn" class="pagination-btn" onclick="goToPage(currentPage - 1)">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="m15 18-6-6 6-6"/>
                        </svg>
                        Trước
                    </button>
                    
                    <div id="pageNumbers" style="display: flex; gap: 8px; align-items: center;"></div>
                    
                    <button id="nextPageBtn" class="pagination-btn" onclick="goToPage(currentPage + 1)">
                        Sau
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="m9 18 6-6-6-6"/>
                        </svg>
                    </button>
                    <button id="lastPageBtn" class="pagination-btn" onclick="goToPage(totalPages)">
                        Cuối
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="m13 17 5-5-5-5"/>
                            <path d="m6 17 5-5-5-5"/>
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- Tab Học sinh -->
            <div id="studentsTab" class="tab-content">
                <div class="controls">
                    <div class="control-group">
                        <label>Tìm học sinh:</label>
                        <div class="search-container">
                            <input type="text" id="studentSearch" placeholder="Nhập tên học sinh..." />
                            <div id="studentDropdown" class="dropdown"></div>
                        </div>
                    </div>
                    <div class="control-group">
                        <label>Lọc theo lớp:</label>
                        <select id="studentClassFilter">
                            <option value="">Tất cả lớp</option>
                        </select>
                    </div>
                </div>
                <div id="studentsList"></div>
            </div>
            
            <!-- Tab Giáo viên -->
            <div id="teachersTab" class="tab-content">
                <div class="controls">
                    <div class="control-group">
                        <label>Tìm giáo viên:</label>
                        <div class="search-container">
                            <input type="text" id="teacherSearch" placeholder="Nhập tên giáo viên..." />
                            <div id="teacherDropdown" class="dropdown"></div>
                        </div>
                    </div>
                </div>
                <div id="teachersList"></div>
            </div>
            
            <!-- Tab Phòng học -->
            <div id="roomsTab" class="tab-content">
                <div class="controls">
                    <div class="control-group">
                        <label>Tìm phòng:</label>
                        <div class="search-container">
                            <input type="text" id="roomSearch" placeholder="Nhập tên phòng..." />
                            <div id="roomDropdown" class="dropdown"></div>
                        </div>
                    </div>
                </div>
                <div id="roomsList"></div>
            </div>
            
            <!-- Tab Lớp học -->
            <div id="classesTab" class="tab-content">
                <div class="controls">
                    <div class="control-group">
                        <label>Tìm lớp:</label>
                        <div class="search-container">
                            <input type="text" id="classSearch" placeholder="Nhập tên lớp..." />
                            <div id="classDropdown" class="dropdown"></div>
                        </div>
                    </div>
                </div>
                <div id="classesList"></div>
            </div>
            
            <!-- Tab Mã lớp -->
            <div id="codesTab" class="tab-content">
                <div class="controls">
                    <div class="control-group">
                        <label>Tìm mã lớp:</label>
                        <div class="search-container">
                            <input type="text" id="codeSearch" placeholder="Nhập mã lớp..." />
                            <div id="codeDropdown" class="dropdown"></div>
                        </div>
                    </div>
                    <div class="control-group">
                        <label>Lọc theo giáo viên:</label>
                        <select id="codeTeacherFilter">
                            <option value="">Tất cả giáo viên</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label>Chọn mã lớp:</label>
                        <select id="codeSelectFilter">
                            <option value="">Tất cả mã lớp</option>
                        </select>
                    </div>
                </div>
                <div id="codesList"></div>
            </div>
            
            <div class="export-section">
                <h3 style="margin-bottom: 20px; color: var(--text-primary);">📄 In và Xuất Thời Khóa Biểu</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <button class="export-btn" onclick="printOverview()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                            <polyline points="6,9 6,2 18,2 18,9"/>
                            <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/>
                            <rect x="6" y="14" width="12" height="8"/>
                        </svg>
                        In Tổng Quan
                    </button>
                    <button class="export-btn" onclick="printStudents()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                            <circle cx="12" cy="7" r="4"/>
                        </svg>
                        In Học Sinh
                    </button>
                    <button class="export-btn" onclick="printTeachers()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                            <circle cx="9" cy="7" r="4"/>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                        </svg>
                        In Giáo Viên
                    </button>
                    <button class="export-btn" onclick="printRooms()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                            <polyline points="9,22 9,12 15,12 15,22"/>
                        </svg>
                        In Phòng Học
                    </button>
                    <button class="export-btn" onclick="printClasses()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                            <line x1="16" y1="2" x2="16" y2="6"/>
                            <line x1="8" y1="2" x2="8" y2="6"/>
                            <line x1="3" y1="10" x2="21" y2="10"/>
                        </svg>
                        In Lớp Học
                    </button>
                    <button class="export-btn" onclick="printCodes()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                            <polyline points="16,18 22,12 16,6"/>
                            <polyline points="8,6 2,12 8,18"/>
                        </svg>
                        In Mã Lớp
                    </button>
                </div>
                <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                    <button class="export-btn" onclick="exportToCSV()" style="background: var(--warning);">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14,2 14,8 20,8"/>
                            <line x1="12" y1="18" x2="12" y2="12"/>
                            <polyline points="9,15 12,18 15,15"/>
                        </svg>
                        Xuất CSV
                    </button>
                    <button class="export-btn" onclick="exportToExcel()" style="background: var(--success);">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14,2 14,8 20,8"/>
                            <line x1="16" y1="13" x2="8" y2="13"/>
                            <line x1="16" y1="17" x2="8" y2="17"/>
                            <polyline points="10,9 9,9 8,9"/>
                        </svg>
                        Xuất Excel
                    </button>
                </div>
            </div>
            </div>
            
            <!-- Upload Section moved to bottom -->
            <div class="upload-section">
                <h3 style="text-align: center; margin-bottom: 20px; color: var(--text-primary);">📁 Tải lên file Excel/CSV của bạn</h3>
                <div class="upload-area" id="uploadArea">
                    <h3>Kéo thả file Excel/CSV vào đây hoặc click để chọn</h3>
                    <p>Hỗ trợ định dạng: .xlsx, .xls, .csv</p>
                    <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                        Chọn File Excel/CSV
                    </button>
                    <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls,.csv" />
                </div>
                <div id="errorMessage"></div>
            </div>
        </div>
    </div>

    <script>
        let scheduleData = [];
        let filteredData = [];
        
        // Pagination variables
        let currentPage = 1;
        let itemsPerPage = 20;
        let totalPages = 1;
        
        // Theme colors configuration
        const themes = {
            blue: {
                primary: '#2563eb',
                primaryLight: '#60a5fa',
                primaryDark: '#1d4ed8'
            },
            green: {
                primary: '#059669',
                primaryLight: '#34d399',
                primaryDark: '#047857'
            },
            purple: {
                primary: '#7c3aed',
                primaryLight: '#a78bfa',
                primaryDark: '#6d28d9'
            },
            red: {
                primary: '#dc2626',
                primaryLight: '#f87171',
                primaryDark: '#b91c1c'
            },
            orange: {
                primary: '#ea580c',
                primaryLight: '#fb923c',
                primaryDark: '#c2410c'
            },
            pink: {
                primary: '#db2777',
                primaryLight: '#f472b6',
                primaryDark: '#be185d'
            },
            indigo: {
                primary: '#4338ca',
                primaryLight: '#818cf8',
                primaryDark: '#3730a3'
            },
            teal: {
                primary: '#0d9488',
                primaryLight: '#5eead4',
                primaryDark: '#0f766e'
            }
        };
        
        // Xử lý upload file và Google Sheets
        const fileInput = document.getElementById('fileInput');
        const uploadArea = document.getElementById('uploadArea');
        const errorMessage = document.getElementById('errorMessage');
        
        // Google Sheets configuration
        const GOOGLE_SHEETS_URL = 'https://docs.google.com/spreadsheets/d/15e4lW8-XOfB8HX51J2xKrFfnGkd2rFEe3H8UY9crhH0/export?format=csv&gid=0';
        
        fileInput.addEventListener('change', handleFile);
        
        // Tự động tải dữ liệu từ Google Sheets khi trang load
        document.addEventListener('DOMContentLoaded', () => {
            initThemeSelector();
            // Hiển thị dữ liệu mẫu ngay lập tức
            createSampleData();
            // Thử tải Google Sheets trong background
            tryLoadGoogleSheetsData();
        });
        
        // Drag and drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                handleFile();
            }
        });
        
        // Thử tải dữ liệu từ Google Sheets (không hiển thị lỗi)
        async function tryLoadGoogleSheetsData() {
            try {
                // Thử với URL trực tiếp trước
                let response = await fetch(GOOGLE_SHEETS_URL);
                
                // Nếu không thành công, thử với CORS proxy
                if (!response.ok) {
                    const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(GOOGLE_SHEETS_URL)}`;
                    response = await fetch(proxyUrl);
                    
                    if (response.ok) {
                        const data = await response.json();
                        const csvText = data.contents;
                        const jsonData = parseCSV(csvText);
                        
                        if (jsonData.length > 0) {
                            processCSVData(jsonData);
                            showError('✅ Đã tải dữ liệu từ Google Sheets thành công!');
                            setTimeout(clearError, 3000);
                            return;
                        }
                    }
                }
                
                // Nếu thành công với URL trực tiếp
                if (response.ok) {
                    const csvText = await response.text();
                    const jsonData = parseCSV(csvText);
                    
                    if (jsonData.length > 0) {
                        processCSVData(jsonData);
                        showError('✅ Đã tải dữ liệu từ Google Sheets thành công!');
                        setTimeout(clearError, 3000);
                        return;
                    }
                }
                
                // Nếu không có dữ liệu, tạo dữ liệu mẫu
                createSampleData();
                
            } catch (error) {
                // Nếu lỗi, tạo dữ liệu mẫu thay vì hiển thị lỗi
                createSampleData();
            }
        }
        
        // Tạo dữ liệu mẫu để demo - định dạng CSV khớp với dữ liệu thực tế
        function createSampleData() {
            // Dữ liệu CSV mẫu theo định dạng: LỚP,HỌ VÀ TÊN,t2,GV_t2,t3,GV_t3,t4,GV_t4,mã t2,phòng t2,mã t3,phòng t3,mã t4,phòng t4
            const sampleCSV = `LỚP,HỌ VÀ TÊN,t2,GV_t2,t3,GV_t3,t4,GV_t4,mã t2,phòng t2,mã t3,phòng t3,mã t4,phòng t4
12A1,CAO ANH QUANG,LY,VÕ THỊ HỒNG,HOA,NGUYỄN THÀNH LUÂN,,,LY04,D201,HOA02,D302,,,
12A1,CAO ĐĂNG KHÔI,LY,VÕ THỊ HỒNG,HOA,NGUYỄN ANH THƯ,,,LY04,D201,HOA04,D305,,,
12A1,HOÀNG GIA KIÊN,LY,VÕ THỊ THANH LAN,HOA,ĐẶNG QUANG HUY,,,LY06,D204,HOA05,A108,,,
12A1,HOÀNG PHÚC VINH,LY,TRẦN THỊ HƯƠNG GIANG,HOA,NGUYỄN ANH THƯ,,,LY02,D104,HOA04,D305,,,
12A1,HUỲNH QUANG LỘC,LY,NGUYỄN THỊ NGỌC PHƯỢNG,HOA,ĐẶNG QUANG HUY,,,LY05,D101,HOA05,A108,,,
12A2,NGUYỄN VĂN MINH,HOA,NGUYỄN THÀNH LUÂN,SINH,TRẦN VĂN DŨNG,,,HOA02,D302,SINH03,B105,,,
12A2,TRẦN THỊ LAN,HOA,NGUYỄN ANH THƯ,SINH,TRẦN VĂN DŨNG,,,HOA04,D305,SINH03,B105,,,
12A3,LÊ VĂN HÙNG,LY,VÕ THỊ HỒNG,HOA,ĐẶNG QUANG HUY,SINH,TRẦN VĂN DŨNG,LY04,D201,HOA05,A108,SINH01,B102
12A3,PHẠM THỊ MAI,LY,VÕ THỊ THANH LAN,HOA,NGUYỄN THÀNH LUÂN,SINH,TRẦN VĂN DŨNG,LY06,D204,HOA02,D302,SINH01,B102`;
            
            // Chuyển đổi CSV thành JSON
            const sampleData = parseCSV(sampleCSV);
            
            processCSVData(sampleData);
            showError('✨ Đang hiển thị dữ liệu mẫu. Cuộn xuống dưới để tải file Excel (.xlsx, .xls) hoặc CSV (.csv) của bạn!');
            setTimeout(clearError, 8000);
        }
        
        // Chuyển đổi CSV thành JSON - hỗ trợ cả dấu phẩy đơn giản và có ngoặc kép
        function parseCSV(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim());
            if (lines.length < 2) return [];
            
            // Hàm phân tích một dòng CSV - tự động phát hiện định dạng
            function parseCSVLine(line) {
                // Kiểm tra xem có dấu ngoặc kép không
                const hasQuotes = line.includes('"');
                
                if (!hasQuotes) {
                    // Định dạng đơn giản với dấu phẩy
                    return line.split(',').map(value => value.trim());
                }
                
                // Định dạng phức tạp với dấu ngoặc kép
                const result = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    
                    if (char === '"') {
                        if (inQuotes && line[i + 1] === '"') {
                            // Dấu ngoặc kép đôi -> một dấu ngoặc kép thực
                            current += '"';
                            i++; // Bỏ qua ký tự tiếp theo
                        } else {
                            // Bắt đầu hoặc kết thúc chuỗi có dấu ngoặc kép
                            inQuotes = !inQuotes;
                        }
                    } else if (char === ',' && !inQuotes) {
                        // Dấu phẩy phân cách (không trong ngoặc kép)
                        result.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                
                // Thêm giá trị cuối cùng
                result.push(current.trim());
                return result;
            }
            
            const headers = parseCSVLine(lines[0]);
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                const row = {};
                
                headers.forEach((header, index) => {
                    row[header] = values[index] || '';
                });
                
                // Chỉ thêm dòng có dữ liệu
                if (Object.values(row).some(value => value.trim() !== '')) {
                    data.push(row);
                }
            }
            
            return data;
        }
        
        function handleFile() {
            const file = fileInput.files[0];
            if (!file) return;
            
            const fileName = file.name.toLowerCase();
            const isExcel = fileName.endsWith('.xlsx') || fileName.endsWith('.xls');
            const isCSV = fileName.endsWith('.csv');
            
            if (!isExcel && !isCSV) {
                showError('Vui lòng chọn file Excel (.xlsx, .xls) hoặc CSV (.csv)');
                return;
            }
            
            const reader = new FileReader();
            
            if (isExcel) {
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        // Lấy sheet đầu tiên
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        
                        // Chuyển đổi thành JSON
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        
                        if (jsonData.length === 0) {
                            showError('File Excel không có dữ liệu');
                            return;
                        }
                        
                        // Chuyển đổi từ array format sang object format
                        const headers = jsonData[0];
                        const rows = jsonData.slice(1).map(row => {
                            const obj = {};
                            headers.forEach((header, index) => {
                                obj[header] = row[index] || '';
                            });
                            return obj;
                        });
                        
                        processCSVData(rows);
                    } catch (error) {
                        showError('Lỗi đọc file Excel: ' + error.message);
                    }
                };
                reader.readAsArrayBuffer(file);
            } else {
                reader.onload = function(e) {
                    try {
                        const csvText = e.target.result;
                        const jsonData = parseCSV(csvText);
                        
                        if (jsonData.length === 0) {
                            showError('File CSV không có dữ liệu hoặc định dạng không đúng');
                            return;
                        }
                        
                        processCSVData(jsonData);
                    } catch (error) {
                        showError('Lỗi đọc file CSV: ' + error.message);
                    }
                };
                reader.readAsText(file, 'UTF-8');
            }
        }
        
        function processCSVData(data) {
            if (data.length === 0) {
                showError('File CSV không có dữ liệu');
                return;
            }
            
            // Kiểm tra các cột bắt buộc
            const requiredColumns = ['LỚP', 'HỌ VÀ TÊN', 't2', 'GV_t2', 't3', 'GV_t3', 't4', 'GV_t4'];
            const firstRow = data[0];
            const missingColumns = requiredColumns.filter(col => !(col in firstRow));
            
            if (missingColumns.length > 0) {
                showError(`Thiếu các cột: ${missingColumns.join(', ')}`);
                return;
            }
            
            scheduleData = data.map((row, index) => ({
                id: index + 1,
                class: row['LỚP'] || '',
                studentName: row['HỌ VÀ TÊN'] || '',
                monday: {
                    subject: row['t2'] || '',
                    teacher: row['GV_t2'] || '',
                    code: row['mã t2'] || '',
                    room: row['phòng t2'] || ''
                },
                tuesday: {
                    subject: row['t3'] || '',
                    teacher: row['GV_t3'] || '',
                    code: row['mã t3'] || '',
                    room: row['phòng t3'] || ''
                },
                wednesday: {
                    subject: row['t4'] || '',
                    teacher: row['GV_t4'] || '',
                    code: row['mã t4'] || '',
                    room: row['phòng t4'] || ''
                }
            }));
            
            filteredData = [...scheduleData];
            clearError();
            displaySchedule();
            setupFilters();
            showStats();
            document.getElementById('scheduleContainer').style.display = 'block';
        }
        
        function displaySchedule() {
            const tableContainer = document.getElementById('scheduleTable');
            
            // Calculate pagination
            totalPages = Math.ceil(filteredData.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const currentPageData = filteredData.slice(startIndex, endIndex);
            
            let html = `
                <table class="schedule-table">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Lớp</th>
                            <th>Họ và Tên</th>
                            <th colspan="4">Tiết 2</th>
                            <th colspan="4">Tiết 3</th>
                            <th colspan="4">Tiết 4</th>
                        </tr>
                        <tr>
                            <th></th>
                            <th></th>
                            <th></th>
                            <th>Môn học</th>
                            <th>Giáo viên</th>
                            <th>Mã</th>
                            <th>Phòng</th>
                            <th>Môn học</th>
                            <th>Giáo viên</th>
                            <th>Mã</th>
                            <th>Phòng</th>
                            <th>Môn học</th>
                            <th>Giáo viên</th>
                            <th>Mã</th>
                            <th>Phòng</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            currentPageData.forEach((row, index) => {
                const globalIndex = startIndex + index + 1;
                html += `
                    <tr>
                        <td>${globalIndex}</td>
                        <td><span class="class-name">${row.class}</span></td>
                        <td><span class="student-name">${row.studentName}</span></td>
                        <td class="subject-cell">${row.monday.subject}</td>
                        <td class="teacher-cell">${row.monday.teacher}</td>
                        <td>${row.monday.code}</td>
                        <td class="room-cell">${row.monday.room}</td>
                        <td class="subject-cell">${row.tuesday.subject}</td>
                        <td class="teacher-cell">${row.tuesday.teacher}</td>
                        <td>${row.tuesday.code}</td>
                        <td class="room-cell">${row.tuesday.room}</td>
                        <td class="subject-cell">${row.wednesday.subject}</td>
                        <td class="teacher-cell">${row.wednesday.teacher}</td>
                        <td>${row.wednesday.code}</td>
                        <td class="room-cell">${row.wednesday.room}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            tableContainer.innerHTML = html;
            
            // Update pagination info and controls
            updatePaginationInfo();
            updatePaginationControls();
        }
        
        function setupFilters() {
            const classFilter = document.getElementById('classFilter');
            const dayFilter = document.getElementById('dayFilter');
            const studentClassFilter = document.getElementById('studentClassFilter');
            
            // Lấy danh sách lớp
            const classes = [...new Set(scheduleData.map(row => row.class))].filter(c => c).sort();
            
            // Cập nhật tất cả dropdown lớp
            [classFilter, studentClassFilter].forEach(filter => {
                if (filter) {
                    filter.innerHTML = '<option value="">Tất cả lớp</option>';
                    classes.forEach(cls => {
                        filter.innerHTML += `<option value="${cls}">${cls}</option>`;
                    });
                }
            });
            
            // Thêm event listeners
            classFilter.addEventListener('change', applyFilters);
            dayFilter.addEventListener('change', applyFilters);
            studentClassFilter.addEventListener('change', displayStudents);
            
            document.getElementById('studentSearch').addEventListener('input', handleStudentSearch);
            document.getElementById('teacherSearch').addEventListener('input', handleTeacherSearch);
            document.getElementById('roomSearch').addEventListener('input', handleRoomSearch);
            document.getElementById('classSearch').addEventListener('input', handleClassSearch);
            document.getElementById('codeSearch').addEventListener('input', handleCodeSearch);
            
            // Thêm event listener cho focus để hiển thị dropdown
            document.getElementById('studentSearch').addEventListener('focus', handleStudentSearch);
            document.getElementById('teacherSearch').addEventListener('focus', handleTeacherSearch);
            document.getElementById('roomSearch').addEventListener('focus', handleRoomSearch);
            document.getElementById('classSearch').addEventListener('focus', handleClassSearch);
            document.getElementById('codeSearch').addEventListener('focus', handleCodeSearch);
            
            // Setup filters cho tab mã lớp
            setupCodeFilters();
            
            // Ẩn dropdown khi click bên ngoài
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.search-container')) {
                    document.getElementById('studentDropdown').style.display = 'none';
                    document.getElementById('teacherDropdown').style.display = 'none';
                    document.getElementById('roomDropdown').style.display = 'none';
                    document.getElementById('classDropdown').style.display = 'none';
                    document.getElementById('codeDropdown').style.display = 'none';
                }
            });
        }
        
        function switchTab(tabName) {
            // Ẩn tất cả tab content
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Bỏ active từ tất cả tab buttons
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Hiển thị tab được chọn
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');
            
            // Load dữ liệu cho tab tương ứng
            switch(tabName) {
                case 'all':
                    displaySchedule();
                    break;
                case 'students':
                    displayStudents();
                    break;
                case 'teachers':
                    displayTeachers();
                    break;
                case 'rooms':
                    displayRooms();
                    break;
                case 'classes':
                    displayClasses();
                    break;
                case 'codes':
                    displayCodes();
                    break;
            }
        }
        
        function displayStudents() {
            const container = document.getElementById('studentsList');
            const classFilter = document.getElementById('studentClassFilter').value;
            const searchTerm = document.getElementById('studentSearch').value.toLowerCase();
            
            let students = scheduleData.filter(row => {
                let matchClass = !classFilter || row.class === classFilter;
                let matchSearch = !searchTerm || row.studentName.toLowerCase().includes(searchTerm);
                return matchClass && matchSearch;
            });
            
            let html = '';
            students.forEach(student => {
                html += `
                    <div class="student-card">
                        <div class="student-header">
                            <div class="student-info">
                                <h3>${student.studentName}</h3>
                                <p>Lớp: ${student.class}</p>
                            </div>
                        </div>
                        <div class="schedule-grid">
                            ${student.monday.subject ? `
                            <div class="period-card">
                                <div class="period-title">Tiết 2</div>
                                <div class="period-info">
                                    <strong>Môn:</strong> ${student.monday.subject}<br>
                                    <strong>GV:</strong> ${student.monday.teacher || 'Không có'}<br>
                                    <strong>Phòng:</strong> ${student.monday.room || 'Không có'}<br>
                                    <strong>Mã:</strong> ${student.monday.code || 'Không có'}
                                </div>
                            </div>
                            ` : ''}
                            ${student.tuesday.subject ? `
                            <div class="period-card">
                                <div class="period-title">Tiết 3</div>
                                <div class="period-info">
                                    <strong>Môn:</strong> ${student.tuesday.subject}<br>
                                    <strong>GV:</strong> ${student.tuesday.teacher || 'Không có'}<br>
                                    <strong>Phòng:</strong> ${student.tuesday.room || 'Không có'}<br>
                                    <strong>Mã:</strong> ${student.tuesday.code || 'Không có'}
                                </div>
                            </div>
                            ` : ''}
                            ${student.wednesday.subject ? `
                            <div class="period-card">
                                <div class="period-title">Tiết 4</div>
                                <div class="period-info">
                                    <strong>Môn:</strong> ${student.wednesday.subject}<br>
                                    <strong>GV:</strong> ${student.wednesday.teacher || 'Không có'}<br>
                                    <strong>Phòng:</strong> ${student.wednesday.room || 'Không có'}<br>
                                    <strong>Mã:</strong> ${student.wednesday.code || 'Không có'}
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html || '<p>Không tìm thấy học sinh nào.</p>';
        }
        
        function displayTeachers() {
            const container = document.getElementById('teachersList');
            const searchTerm = document.getElementById('teacherSearch').value.toLowerCase();
            
            // Tạo danh sách giáo viên và lịch dạy
            const teacherSchedule = {};
            
            scheduleData.forEach(row => {
                // Tiết 2
                if (row.monday.teacher) {
                    if (!teacherSchedule[row.monday.teacher]) {
                        teacherSchedule[row.monday.teacher] = {};
                    }
                    if (!teacherSchedule[row.monday.teacher]['Tiết 2']) {
                        teacherSchedule[row.monday.teacher]['Tiết 2'] = [];
                    }
                    teacherSchedule[row.monday.teacher]['Tiết 2'].push({
                        room: row.monday.room,
                        student: row.studentName,
                        class: row.class,
                        code: row.monday.code
                    });
                }
                
                // Tiết 3
                if (row.tuesday.teacher) {
                    if (!teacherSchedule[row.tuesday.teacher]) {
                        teacherSchedule[row.tuesday.teacher] = {};
                    }
                    if (!teacherSchedule[row.tuesday.teacher]['Tiết 3']) {
                        teacherSchedule[row.tuesday.teacher]['Tiết 3'] = [];
                    }
                    teacherSchedule[row.tuesday.teacher]['Tiết 3'].push({
                        room: row.tuesday.room,
                        student: row.studentName,
                        class: row.class,
                        code: row.tuesday.code
                    });
                }
                
                // Tiết 4
                if (row.wednesday.teacher) {
                    if (!teacherSchedule[row.wednesday.teacher]) {
                        teacherSchedule[row.wednesday.teacher] = {};
                    }
                    if (!teacherSchedule[row.wednesday.teacher]['Tiết 4']) {
                        teacherSchedule[row.wednesday.teacher]['Tiết 4'] = [];
                    }
                    teacherSchedule[row.wednesday.teacher]['Tiết 4'].push({
                        room: row.wednesday.room,
                        student: row.studentName,
                        class: row.class,
                        code: row.wednesday.code
                    });
                }
            });
            
            let html = '';
            Object.keys(teacherSchedule).forEach(teacher => {
                if (!searchTerm || teacher.toLowerCase().includes(searchTerm)) {
                    const periods = teacherSchedule[teacher];
                    
                    html += `
                        <div class="teacher-card">
                            <div class="teacher-header">
                                <div class="teacher-info">
                                    <h3>${teacher}</h3>
                                    <p>Dạy ${Object.keys(periods).length} tiết</p>
                                </div>
                            </div>
                            <div class="schedule-grid">
                    `;
                    
                    Object.keys(periods).forEach(period => {
                        const students = periods[period];
                        const rooms = [...new Set(students.map(s => s.room).filter(r => r))];
                        const codes = [...new Set(students.map(s => s.code).filter(c => c))];
                        
                        html += `
                            <div class="period-card">
                                <div class="period-title">${period}</div>
                                <div class="period-info">
                                    <strong>Phòng:</strong> ${rooms.join(', ') || 'Không có'}<br>
                                    <strong>Mã lớp:</strong> ${codes.join(', ') || 'Không có'}<br>
                                    <strong>Số học sinh:</strong> ${students.length}<br>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                }
            });
            
            container.innerHTML = html || '<p>Không tìm thấy giáo viên nào.</p>';
        }
        
        function displayRooms() {
            const container = document.getElementById('roomsList');
            const searchTerm = document.getElementById('roomSearch').value.toLowerCase();
            
            // Tạo danh sách phòng và lịch sử dụng
            const roomSchedule = {};
            
            scheduleData.forEach(row => {
                // Tiết 2
                if (row.monday.room) {
                    if (!roomSchedule[row.monday.room]) {
                        roomSchedule[row.monday.room] = [];
                    }
                    roomSchedule[row.monday.room].push({
                        period: 'Tiết 2',
                        teacher: row.monday.teacher,
                        subject: row.monday.subject,
                        code: row.monday.code,
                        student: row.studentName,
                        class: row.class
                    });
                }
                
                // Tiết 3
                if (row.tuesday.room) {
                    if (!roomSchedule[row.tuesday.room]) {
                        roomSchedule[row.tuesday.room] = [];
                    }
                    roomSchedule[row.tuesday.room].push({
                        period: 'Tiết 3',
                        teacher: row.tuesday.teacher,
                        subject: row.tuesday.subject,
                        code: row.tuesday.code,
                        student: row.studentName,
                        class: row.class
                    });
                }
                
                // Tiết 4
                if (row.wednesday.room) {
                    if (!roomSchedule[row.wednesday.room]) {
                        roomSchedule[row.wednesday.room] = [];
                    }
                    roomSchedule[row.wednesday.room].push({
                        period: 'Tiết 4',
                        teacher: row.wednesday.teacher,
                        subject: row.wednesday.subject,
                        code: row.wednesday.code,
                        student: row.studentName,
                        class: row.class
                    });
                }
            });
            
            let html = '';
            Object.keys(roomSchedule).forEach(room => {
                if (!searchTerm || room.toLowerCase().includes(searchTerm)) {
                    const schedule = roomSchedule[room];
                    const teachers = [...new Set(schedule.map(s => s.teacher).filter(t => t))];
                    const periods = [...new Set(schedule.map(s => s.period))];
                    
                    html += `
                        <div class="room-card">
                            <div class="room-header">
                                <div class="room-info">
                                    <h3>Phòng ${room}</h3>
                                    <p>Giáo viên: ${teachers.join(', ') || 'Chưa có'} | Tiết: ${periods.join(', ')}</p>
                                </div>
                            </div>
                            <div class="schedule-grid">
                    `;
                    
                    // Nhóm theo tiết
                    const periodGroups = {};
                    schedule.forEach(item => {
                        if (!periodGroups[item.period]) {
                            periodGroups[item.period] = [];
                        }
                        periodGroups[item.period].push(item);
                    });
                    
                    Object.keys(periodGroups).forEach(period => {
                        const items = periodGroups[period];
                        html += `
                            <div class="period-card">
                                <div class="period-title">${period}</div>
                                <div class="period-info">
                                    <strong>Môn:</strong> ${items[0].subject}<br>
                                    <strong>GV:</strong> ${items[0].teacher || 'Không có'}
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                }
            });
            
            container.innerHTML = html || '<p>Không tìm thấy phòng nào.</p>';
        }
        
        function displayClasses() {
            const container = document.getElementById('classesList');
            const searchTerm = document.getElementById('classSearch').value.toLowerCase();
            
            // Tạo danh sách lớp
            const classes = [...new Set(scheduleData.map(row => row.class))].filter(c => c);
            
            let html = '';
            classes.forEach(className => {
                if (!searchTerm || className.toLowerCase().includes(searchTerm)) {
                    const classStudents = scheduleData.filter(row => row.class === className);
                    
                    html += `
                        <div class="student-card">
                            <div class="student-header">
                                <div class="student-info">
                                    <h3>Lớp ${className}</h3>
                                    <p>Tổng số: ${classStudents.length} học sinh</p>
                                </div>
                            </div>
                            <div style="margin-top: 20px;">
                                <h4 style="color: var(--text-primary); margin-bottom: 15px;">Danh sách học sinh:</h4>
                    `;
                    
                    classStudents.forEach((student, index) => {
                        html += `
                            <div style="background: var(--surface-alt); padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 3px solid var(--primary-light);">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <strong style="color: var(--primary);">${index + 1}. ${student.studentName}</strong>
                                </div>
                                <div class="schedule-grid">
                                    ${student.monday.subject ? `
                                    <div class="period-card">
                                        <div class="period-title">Tiết 2</div>
                                        <div class="period-info">
                                            <strong>Môn:</strong> ${student.monday.subject}<br>
                                            <strong>GV:</strong> ${student.monday.teacher || 'Không có'}<br>
                                            <strong>Phòng:</strong> ${student.monday.room || 'Không có'}<br>
                                            <strong>Mã:</strong> ${student.monday.code || 'Không có'}
                                        </div>
                                    </div>
                                    ` : ''}
                                    ${student.tuesday.subject ? `
                                    <div class="period-card">
                                        <div class="period-title">Tiết 3</div>
                                        <div class="period-info">
                                            <strong>Môn:</strong> ${student.tuesday.subject}<br>
                                            <strong>GV:</strong> ${student.tuesday.teacher || 'Không có'}<br>
                                            <strong>Phòng:</strong> ${student.tuesday.room || 'Không có'}<br>
                                            <strong>Mã:</strong> ${student.tuesday.code || 'Không có'}
                                        </div>
                                    </div>
                                    ` : ''}
                                    ${student.wednesday.subject ? `
                                    <div class="period-card">
                                        <div class="period-title">Tiết 4</div>
                                        <div class="period-info">
                                            <strong>Môn:</strong> ${student.wednesday.subject}<br>
                                            <strong>GV:</strong> ${student.wednesday.teacher || 'Không có'}<br>
                                            <strong>Phòng:</strong> ${student.wednesday.room || 'Không có'}<br>
                                            <strong>Mã:</strong> ${student.wednesday.code || 'Không có'}
                                        </div>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                }
            });
            
            container.innerHTML = html || '<p>Không tìm thấy lớp nào.</p>';
        }
        
        function showClassDetails(className) {
            // Chuyển sang tab học sinh và lọc theo lớp
            switchTab('students');
            document.getElementById('studentClassFilter').value = className;
            displayStudents();
            
            // Cập nhật tab active
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector('.tab:nth-child(2)').classList.add('active');
        }
        
        function handleStudentSearch() {
            const searchTerm = document.getElementById('studentSearch').value.toLowerCase();
            const dropdown = document.getElementById('studentDropdown');
            
            if (searchTerm.length === 0) {
                dropdown.style.display = 'none';
                displayStudents();
                return;
            }
            
            const matchingStudents = scheduleData.filter(row => 
                row.studentName.toLowerCase().includes(searchTerm)
            );
            
            if (matchingStudents.length > 0) {
                dropdown.innerHTML = matchingStudents.map(student => 
                    `<div class="dropdown-item" onclick="selectStudent('${student.studentName}')">${student.studentName} - ${student.class}</div>`
                ).join('');
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
            
            displayStudents();
        }
        
        function selectStudent(studentName) {
            document.getElementById('studentSearch').value = studentName;
            document.getElementById('studentDropdown').style.display = 'none';
            displaySelectedStudent(studentName);
        }
        
        function displaySelectedStudent(studentName) {
            const container = document.getElementById('studentsList');
            const student = scheduleData.find(row => row.studentName === studentName);
            
            if (!student) {
                container.innerHTML = '<p>Không tìm thấy học sinh.</p>';
                return;
            }
            
            let html = `
                <div class="student-card">
                    <div class="student-header">
                        <div class="student-info">
                            <h3>👨‍🎓 ${student.studentName}</h3>
                            <p>Lớp: ${student.class}</p>
                        </div>
                    </div>
                    <div class="schedule-grid">
                        ${student.monday.subject ? `
                        <div class="period-card">
                            <div class="period-title">📅 Tiết 2</div>
                            <div class="period-info">
                                <strong>Môn:</strong> ${student.monday.subject}<br>
                                <strong>GV:</strong> ${student.monday.teacher || 'Không có'}<br>
                                <strong>Phòng:</strong> ${student.monday.room || 'Không có'}<br>
                                <strong>Mã:</strong> ${student.monday.code || 'Không có'}
                            </div>
                        </div>
                        ` : ''}
                        ${student.tuesday.subject ? `
                        <div class="period-card">
                            <div class="period-title">📅 Tiết 3</div>
                            <div class="period-info">
                                <strong>Môn:</strong> ${student.tuesday.subject}<br>
                                <strong>GV:</strong> ${student.tuesday.teacher || 'Không có'}<br>
                                <strong>Phòng:</strong> ${student.tuesday.room || 'Không có'}<br>
                                <strong>Mã:</strong> ${student.tuesday.code || 'Không có'}
                            </div>
                        </div>
                        ` : ''}
                        ${student.wednesday.subject ? `
                        <div class="period-card">
                            <div class="period-title">📅 Tiết 4</div>
                            <div class="period-info">
                                <strong>Môn:</strong> ${student.wednesday.subject}<br>
                                <strong>GV:</strong> ${student.wednesday.teacher || 'Không có'}<br>
                                <strong>Phòng:</strong> ${student.wednesday.room || 'Không có'}<br>
                                <strong>Mã:</strong> ${student.wednesday.code || 'Không có'}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        function handleTeacherSearch() {
            const searchTerm = document.getElementById('teacherSearch').value.toLowerCase();
            const dropdown = document.getElementById('teacherDropdown');
            
            if (searchTerm.length === 0) {
                dropdown.style.display = 'none';
                displayTeachers();
                return;
            }
            
            const teachers = new Set();
            scheduleData.forEach(row => {
                if (row.monday.teacher) teachers.add(row.monday.teacher);
                if (row.tuesday.teacher) teachers.add(row.tuesday.teacher);
                if (row.wednesday.teacher) teachers.add(row.wednesday.teacher);
            });
            
            const filteredTeachers = [...teachers].filter(teacher => 
                teacher.toLowerCase().includes(searchTerm)
            );
            
            if (filteredTeachers.length > 0) {
                dropdown.innerHTML = filteredTeachers.map(teacher => 
                    `<div class="dropdown-item" onclick="selectTeacher('${teacher}')">${teacher}</div>`
                ).join('');
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
            
            displayTeachers();
        }
        
        function selectTeacher(teacherName) {
            document.getElementById('teacherSearch').value = teacherName;
            document.getElementById('teacherDropdown').style.display = 'none';
            displaySelectedTeacher(teacherName);
        }
        
        function displaySelectedTeacher(teacherName) {
            const container = document.getElementById('teachersList');
            
            // Tạo lịch dạy cho giáo viên được chọn
            const teacherSchedule = {};
            
            scheduleData.forEach(row => {
                // Tiết 2
                if (row.monday.teacher === teacherName) {
                    if (!teacherSchedule['Tiết 2']) {
                        teacherSchedule['Tiết 2'] = [];
                    }
                    teacherSchedule['Tiết 2'].push({
                        room: row.monday.room,
                        student: row.studentName,
                        class: row.class,
                        subject: row.monday.subject,
                        code: row.monday.code
                    });
                }
                
                // Tiết 3
                if (row.tuesday.teacher === teacherName) {
                    if (!teacherSchedule['Tiết 3']) {
                        teacherSchedule['Tiết 3'] = [];
                    }
                    teacherSchedule['Tiết 3'].push({
                        room: row.tuesday.room,
                        student: row.studentName,
                        class: row.class,
                        subject: row.tuesday.subject,
                        code: row.tuesday.code
                    });
                }
                
                // Tiết 4
                if (row.wednesday.teacher === teacherName) {
                    if (!teacherSchedule['Tiết 4']) {
                        teacherSchedule['Tiết 4'] = [];
                    }
                    teacherSchedule['Tiết 4'].push({
                        room: row.wednesday.room,
                        student: row.studentName,
                        class: row.class,
                        subject: row.wednesday.subject,
                        code: row.wednesday.code
                    });
                }
            });
            
            if (Object.keys(teacherSchedule).length === 0) {
                container.innerHTML = '<p>Không tìm thấy lịch dạy cho giáo viên này.</p>';
                return;
            }
            
            let html = `
                <div class="teacher-card">
                    <div class="teacher-header">
                        <div class="teacher-info">
                            <h3>👨‍🏫 ${teacherName}</h3>
                            <p>Dạy ${Object.keys(teacherSchedule).length} tiết</p>
                        </div>
                    </div>
                    <div class="schedule-grid">
            `;
            
            Object.keys(teacherSchedule).forEach(period => {
                const students = teacherSchedule[period];
                const rooms = [...new Set(students.map(s => s.room).filter(r => r))];
                const subjects = [...new Set(students.map(s => s.subject).filter(s => s))];
                const codes = [...new Set(students.map(s => s.code).filter(c => c))];
                
                html += `
                    <div class="period-card">
                        <div class="period-title">📅 ${period}</div>
                        <div class="period-info">
                            <strong>Môn:</strong> ${subjects.join(', ')}<br>
                            <strong>Phòng:</strong> ${rooms.join(', ') || 'Không có'}<br>
                            <strong>Mã lớp:</strong> ${codes.join(', ') || 'Không có'}<br>
                            <strong>Số học sinh:</strong> ${students.length}<br>
                            <strong>Lớp:</strong> ${[...new Set(students.map(s => s.class))].join(', ')}
                        </div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        function handleRoomSearch() {
            const searchTerm = document.getElementById('roomSearch').value.toLowerCase();
            const dropdown = document.getElementById('roomDropdown');
            
            if (searchTerm.length === 0) {
                dropdown.style.display = 'none';
                displayRooms();
                return;
            }
            
            const rooms = new Set();
            scheduleData.forEach(row => {
                if (row.monday.room) rooms.add(row.monday.room);
                if (row.tuesday.room) rooms.add(row.tuesday.room);
                if (row.wednesday.room) rooms.add(row.wednesday.room);
            });
            
            const filteredRooms = [...rooms].filter(room => 
                room.toLowerCase().includes(searchTerm)
            );
            
            if (filteredRooms.length > 0) {
                dropdown.innerHTML = filteredRooms.map(room => 
                    `<div class="dropdown-item" onclick="selectRoom('${room}')">${room}</div>`
                ).join('');
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
            
            displayRooms();
        }
        
        function selectRoom(roomName) {
            document.getElementById('roomSearch').value = roomName;
            document.getElementById('roomDropdown').style.display = 'none';
            displaySelectedRoom(roomName);
        }
        
        function displaySelectedRoom(roomName) {
            const container = document.getElementById('roomsList');
            
            // Tạo lịch sử dụng phòng
            const roomSchedule = [];
            
            scheduleData.forEach(row => {
                // Tiết 2
                if (row.monday.room === roomName) {
                    roomSchedule.push({
                        period: 'Tiết 2',
                        teacher: row.monday.teacher,
                        subject: row.monday.subject,
                        code: row.monday.code,
                        student: row.studentName,
                        class: row.class
                    });
                }
                
                // Tiết 3
                if (row.tuesday.room === roomName) {
                    roomSchedule.push({
                        period: 'Tiết 3',
                        teacher: row.tuesday.teacher,
                        subject: row.tuesday.subject,
                        code: row.tuesday.code,
                        student: row.studentName,
                        class: row.class
                    });
                }
                
                // Tiết 4
                if (row.wednesday.room === roomName) {
                    roomSchedule.push({
                        period: 'Tiết 4',
                        teacher: row.wednesday.teacher,
                        subject: row.wednesday.subject,
                        code: row.wednesday.code,
                        student: row.studentName,
                        class: row.class
                    });
                }
            });
            
            if (roomSchedule.length === 0) {
                container.innerHTML = '<p>Không tìm thấy lịch sử dụng cho phòng này.</p>';
                return;
            }
            
            const teachers = [...new Set(roomSchedule.map(s => s.teacher).filter(t => t))];
            const periods = [...new Set(roomSchedule.map(s => s.period))];
            
            let html = `
                <div class="room-card">
                    <div class="room-header">
                        <div class="room-info">
                            <h3>🏫 Phòng ${roomName}</h3>
                            <p>Giáo viên: ${teachers.join(', ') || 'Chưa có'} | Tiết: ${periods.join(', ')}</p>
                        </div>
                    </div>
                    <div class="schedule-grid">
            `;
            
            // Nhóm theo tiết
            const periodGroups = {};
            roomSchedule.forEach(item => {
                if (!periodGroups[item.period]) {
                    periodGroups[item.period] = [];
                }
                periodGroups[item.period].push(item);
            });
            
            Object.keys(periodGroups).forEach(period => {
                const items = periodGroups[period];
                const subjects = [...new Set(items.map(i => i.subject).filter(s => s))];
                const teachers = [...new Set(items.map(i => i.teacher).filter(t => t))];
                
                html += `
                    <div class="period-card">
                        <div class="period-title">📅 ${period}</div>
                        <div class="period-info">
                            <strong>Môn:</strong> ${subjects.join(', ')}<br>
                            <strong>GV:</strong> ${teachers.join(', ') || 'Không có'}<br>
                            <strong>Số học sinh:</strong> ${items.length}
                        </div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        function handleClassSearch() {
            const searchTerm = document.getElementById('classSearch').value.toLowerCase();
            const dropdown = document.getElementById('classDropdown');
            
            if (searchTerm.length === 0) {
                dropdown.style.display = 'none';
                displayClasses();
                return;
            }
            
            const allClasses = [...new Set(scheduleData.map(row => row.class))].filter(cls => cls);
            const filteredClasses = allClasses.filter(cls => 
                cls.toLowerCase().includes(searchTerm)
            );
            
            if (filteredClasses.length > 0) {
                dropdown.innerHTML = filteredClasses.map(cls => 
                    `<div class="dropdown-item" onclick="selectClass('${cls}')">${cls}</div>`
                ).join('');
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
            
            displayClasses();
        }
        
        function selectClass(className) {
            document.getElementById('classSearch').value = className;
            document.getElementById('classDropdown').style.display = 'none';
            displaySelectedClass(className);
        }
        
        function displaySelectedClass(className) {
            const container = document.getElementById('classesList');
            const classStudents = scheduleData.filter(row => row.class === className);
            
            if (classStudents.length === 0) {
                container.innerHTML = '<p>Không tìm thấy lớp này.</p>';
                return;
            }
            
            let html = `
                <div class="student-card">
                    <div class="student-header">
                        <div class="student-info">
                            <h3>📚 Lớp ${className}</h3>
                            <p>Tổng số: ${classStudents.length} học sinh</p>
                        </div>
                    </div>
                    <div style="margin-top: 20px;">
                        <h4 style="color: #374151; margin-bottom: 15px;">📋 Danh sách học sinh:</h4>
            `;
            
            classStudents.forEach((student, index) => {
                html += `
                    <div style="background: #f8fafc; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 3px solid #3b82f6;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <strong style="color: #1e40af;">${index + 1}. ${student.studentName}</strong>
                        </div>
                        <div class="schedule-grid">
                            ${student.monday.subject ? `
                            <div class="period-card">
                                <div class="period-title">📅 Tiết 2</div>
                                <div class="period-info">
                                    <strong>Môn:</strong> ${student.monday.subject}<br>
                                    <strong>GV:</strong> ${student.monday.teacher || 'Không có'}<br>
                                    <strong>Phòng:</strong> ${student.monday.room || 'Không có'}<br>
                                    <strong>Mã:</strong> ${student.monday.code || 'Không có'}
                                </div>
                            </div>
                            ` : ''}
                            ${student.tuesday.subject ? `
                            <div class="period-card">
                                <div class="period-title">📅 Tiết 3</div>
                                <div class="period-info">
                                    <strong>Môn:</strong> ${student.tuesday.subject}<br>
                                    <strong>GV:</strong> ${student.tuesday.teacher || 'Không có'}<br>
                                    <strong>Phòng:</strong> ${student.tuesday.room || 'Không có'}<br>
                                    <strong>Mã:</strong> ${student.tuesday.code || 'Không có'}
                                </div>
                            </div>
                            ` : ''}
                            ${student.wednesday.subject ? `
                            <div class="period-card">
                                <div class="period-title">📅 Tiết 4</div>
                                <div class="period-info">
                                    <strong>Môn:</strong> ${student.wednesday.subject}<br>
                                    <strong>GV:</strong> ${student.wednesday.teacher || 'Không có'}<br>
                                    <strong>Phòng:</strong> ${student.wednesday.room || 'Không có'}<br>
                                    <strong>Mã:</strong> ${student.wednesday.code || 'Không có'}
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        function applyFilters() {
            const classFilter = document.getElementById('classFilter').value;
            const dayFilter = document.getElementById('dayFilter').value;
            
            filteredData = scheduleData.filter(row => {
                let matchClass = !classFilter || row.class === classFilter;
                let matchDay = !dayFilter || 
                    (dayFilter === 't2' && row.monday.subject) ||
                    (dayFilter === 't3' && row.tuesday.subject) ||
                    (dayFilter === 't4' && row.wednesday.subject);
                
                return matchClass && matchDay;
            });
            
            // Reset to first page when filtering
            currentPage = 1;
            displaySchedule();
            showStats();
        }
        
        // Pagination functions
        function updatePaginationInfo() {
            const paginationInfo = document.getElementById('paginationInfo');
            const startItem = (currentPage - 1) * itemsPerPage + 1;
            const endItem = Math.min(currentPage * itemsPerPage, filteredData.length);
            
            if (filteredData.length === 0) {
                paginationInfo.innerHTML = 'Không có dữ liệu để hiển thị';
            } else {
                paginationInfo.innerHTML = `Hiển thị ${startItem} - ${endItem} trong tổng số ${filteredData.length} kết quả`;
            }
        }
        
        function updatePaginationControls() {
            const paginationControls = document.getElementById('paginationControls');
            
            if (totalPages <= 1) {
                paginationControls.style.display = 'none';
                return;
            }
            
            paginationControls.style.display = 'flex';
            
            // Update button states
            document.getElementById('firstPageBtn').disabled = currentPage === 1;
            document.getElementById('prevPageBtn').disabled = currentPage === 1;
            document.getElementById('nextPageBtn').disabled = currentPage === totalPages;
            document.getElementById('lastPageBtn').disabled = currentPage === totalPages;
            
            // Update page numbers
            updatePageNumbers();
        }
        
        function updatePageNumbers() {
            const pageNumbersContainer = document.getElementById('pageNumbers');
            let html = '';
            
            // Calculate which page numbers to show
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            // Adjust start page if we're near the end
            if (endPage - startPage < maxVisiblePages - 1) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            // Show first page and ellipsis if needed
            if (startPage > 1) {
                html += `<button class="page-number-btn" onclick="goToPage(1)">1</button>`;
                if (startPage > 2) {
                    html += `<span class="page-ellipsis">...</span>`;
                }
            }
            
            // Show page numbers
            for (let i = startPage; i <= endPage; i++) {
                const activeClass = i === currentPage ? 'active' : '';
                html += `<button class="page-number-btn ${activeClass}" onclick="goToPage(${i})">${i}</button>`;
            }
            
            // Show last page and ellipsis if needed
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    html += `<span class="page-ellipsis">...</span>`;
                }
                html += `<button class="page-number-btn" onclick="goToPage(${totalPages})">${totalPages}</button>`;
            }
            
            pageNumbersContainer.innerHTML = html;
        }
        
        function goToPage(page) {
            if (page < 1 || page > totalPages || page === currentPage) {
                return;
            }
            
            currentPage = page;
            displaySchedule();
            
            // Scroll to top of table
            document.getElementById('scheduleTable').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start' 
            });
        }
        
        function showStats() {
            const statsContainer = document.getElementById('stats');
            const totalStudents = filteredData.length;
            const totalClasses = new Set(filteredData.map(row => row.class)).size;
            const totalSubjects = new Set([
                ...filteredData.map(row => row.monday.subject),
                ...filteredData.map(row => row.tuesday.subject),
                ...filteredData.map(row => row.wednesday.subject)
            ].filter(s => s)).size;
            
            const totalTeachers = new Set([
                ...filteredData.map(row => row.monday.teacher),
                ...filteredData.map(row => row.tuesday.teacher),
                ...filteredData.map(row => row.wednesday.teacher)
            ].filter(t => t)).size;
            
            const totalRooms = new Set([
                ...filteredData.map(row => row.monday.room),
                ...filteredData.map(row => row.tuesday.room),
                ...filteredData.map(row => row.wednesday.room)
            ].filter(r => r)).size;
            
            const totalCodes = new Set([
                ...filteredData.map(row => row.monday.code),
                ...filteredData.map(row => row.tuesday.code),
                ...filteredData.map(row => row.wednesday.code)
            ].filter(c => c)).size;
            
            // Tạo bảng thống kê
            statsContainer.innerHTML = `
                <div style="background: var(--surface); border-radius: var(--radius-lg); padding: 24px; border: 1px solid var(--border); box-shadow: var(--shadow-md);">
                    <h3 style="margin: 0 0 20px 0; color: var(--text-primary); text-align: center; font-size: 1.3rem;">📊 Thống Kê Tổng Quan</h3>
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.95rem;">
                        <thead>
                            <tr style="background: var(--primary); color: white;">
                                <th style="padding: 12px; text-align: left; border-radius: var(--radius-sm) 0 0 0;">Danh Mục</th>
                                <th style="padding: 12px; text-align: center;">Số Lượng</th>
                                <th style="padding: 12px; text-align: left; border-radius: 0 var(--radius-sm) 0 0;">Ghi Chú</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="border-bottom: 1px solid var(--border-light);">
                                <td style="padding: 12px; font-weight: 500; color: var(--text-primary);">👨‍🎓 Học Sinh</td>
                                <td style="padding: 12px; text-align: center; font-weight: 600; color: var(--primary);">${totalStudents}</td>
                                <td style="padding: 12px; color: var(--text-secondary);">Tổng số học sinh trong hệ thống</td>
                            </tr>
                            <tr style="border-bottom: 1px solid var(--border-light); background: var(--surface-alt);">
                                <td style="padding: 12px; font-weight: 500; color: var(--text-primary);">📚 Lớp Học</td>
                                <td style="padding: 12px; text-align: center; font-weight: 600; color: var(--primary);">${totalClasses}</td>
                                <td style="padding: 12px; color: var(--text-secondary);">Số lớp học khác nhau</td>
                            </tr>
                            <tr style="border-bottom: 1px solid var(--border-light);">
                                <td style="padding: 12px; font-weight: 500; color: var(--text-primary);">📖 Môn Học</td>
                                <td style="padding: 12px; text-align: center; font-weight: 600; color: var(--primary);">${totalSubjects}</td>
                                <td style="padding: 12px; color: var(--text-secondary);">Các môn học được giảng dạy</td>
                            </tr>
                            <tr style="border-bottom: 1px solid var(--border-light); background: var(--surface-alt);">
                                <td style="padding: 12px; font-weight: 500; color: var(--text-primary);">👨‍🏫 Giáo Viên</td>
                                <td style="padding: 12px; text-align: center; font-weight: 600; color: var(--primary);">${totalTeachers}</td>
                                <td style="padding: 12px; color: var(--text-secondary);">Số giáo viên tham gia giảng dạy</td>
                            </tr>
                            <tr style="border-bottom: 1px solid var(--border-light);">
                                <td style="padding: 12px; font-weight: 500; color: var(--text-primary);">🏫 Phòng Học</td>
                                <td style="padding: 12px; text-align: center; font-weight: 600; color: var(--primary);">${totalRooms}</td>
                                <td style="padding: 12px; color: var(--text-secondary);">Phòng học được sử dụng</td>
                            </tr>
                            <tr style="background: var(--surface-alt);">
                                <td style="padding: 12px; font-weight: 500; color: var(--text-primary);">🏷️ Mã Lớp</td>
                                <td style="padding: 12px; text-align: center; font-weight: 600; color: var(--primary);">${totalCodes}</td>
                                <td style="padding: 12px; color: var(--text-secondary);">Mã lớp học khác nhau</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        function exportToCSV() {
            // Tạo header CSV
            const headers = [
                'STT', 'Lớp', 'Họ và Tên',
                'Thứ 2 - Môn', 'Thứ 2 - GV', 'Thứ 2 - Mã', 'Thứ 2 - Phòng',
                'Thứ 3 - Môn', 'Thứ 3 - GV', 'Thứ 3 - Mã', 'Thứ 3 - Phòng',
                'Thứ 4 - Môn', 'Thứ 4 - GV', 'Thứ 4 - Mã', 'Thứ 4 - Phòng'
            ];
            
            // Tạo dữ liệu CSV với dấu phẩy làm phân cách
            const csvData = filteredData.map(row => [
                row.id,
                row.class,
                row.studentName,
                row.monday.subject,
                row.monday.teacher,
                row.monday.code,
                row.monday.room,
                row.tuesday.subject,
                row.tuesday.teacher,
                row.tuesday.code,
                row.tuesday.room,
                row.wednesday.subject,
                row.wednesday.teacher,
                row.wednesday.code,
                row.wednesday.room
            ]);
            
            // Tạo nội dung CSV với dấu phẩy
            let csvContent = headers.join(',') + '\n';
            csvData.forEach(row => {
                csvContent += row.map(value => value || '').join(',') + '\n';
            });
            
            // Tải file
            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'thoi_khoa_bieu.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function exportToExcel() {
            // Tạo header Excel
            const headers = [
                'STT', 'Lớp', 'Họ và Tên',
                'Tiết 2 - Môn', 'Tiết 2 - GV', 'Tiết 2 - Mã', 'Tiết 2 - Phòng',
                'Tiết 3 - Môn', 'Tiết 3 - GV', 'Tiết 3 - Mã', 'Tiết 3 - Phòng',
                'Tiết 4 - Môn', 'Tiết 4 - GV', 'Tiết 4 - Mã', 'Tiết 4 - Phòng'
            ];
            
            // Tạo dữ liệu Excel
            const excelData = [headers];
            filteredData.forEach(row => {
                excelData.push([
                    row.id,
                    row.class,
                    row.studentName,
                    row.monday.subject || '',
                    row.monday.teacher || '',
                    row.monday.code || '',
                    row.monday.room || '',
                    row.tuesday.subject || '',
                    row.tuesday.teacher || '',
                    row.tuesday.code || '',
                    row.tuesday.room || '',
                    row.wednesday.subject || '',
                    row.wednesday.teacher || '',
                    row.wednesday.code || '',
                    row.wednesday.room || ''
                ]);
            });
            
            // Tạo workbook và worksheet
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(excelData);
            
            // Định dạng cột
            const colWidths = [
                { wch: 5 },   // STT
                { wch: 8 },   // Lớp
                { wch: 20 },  // Họ và Tên
                { wch: 12 },  // Tiết 2 - Môn
                { wch: 15 },  // Tiết 2 - GV
                { wch: 8 },   // Tiết 2 - Mã
                { wch: 10 },  // Tiết 2 - Phòng
                { wch: 12 },  // Tiết 3 - Môn
                { wch: 15 },  // Tiết 3 - GV
                { wch: 8 },   // Tiết 3 - Mã
                { wch: 10 },  // Tiết 3 - Phòng
                { wch: 12 },  // Tiết 4 - Môn
                { wch: 15 },  // Tiết 4 - GV
                { wch: 8 },   // Tiết 4 - Mã
                { wch: 10 }   // Tiết 4 - Phòng
            ];
            ws['!cols'] = colWidths;
            
            // Thêm worksheet vào workbook
            XLSX.utils.book_append_sheet(wb, ws, 'Thời Khóa Biểu');
            
            // Xuất file Excel
            const fileName = `thoi_khoa_bieu_${new Date().toISOString().slice(0, 10)}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }
        
        // Hàm xử lý mã lớp
        function setupCodeFilters() {
            const codeTeacherFilter = document.getElementById('codeTeacherFilter');
            const codeSelectFilter = document.getElementById('codeSelectFilter');
            
            // Lấy danh sách giáo viên
            const teachers = new Set();
            scheduleData.forEach(row => {
                if (row.monday.teacher) teachers.add(row.monday.teacher);
                if (row.tuesday.teacher) teachers.add(row.tuesday.teacher);
                if (row.wednesday.teacher) teachers.add(row.wednesday.teacher);
            });
            
            // Lấy danh sách mã lớp
            const codes = new Set();
            scheduleData.forEach(row => {
                if (row.monday.code) codes.add(row.monday.code);
                if (row.tuesday.code) codes.add(row.tuesday.code);
                if (row.wednesday.code) codes.add(row.wednesday.code);
            });
            
            // Cập nhật dropdown giáo viên
            codeTeacherFilter.innerHTML = '<option value="">Tất cả giáo viên</option>';
            [...teachers].sort().forEach(teacher => {
                codeTeacherFilter.innerHTML += `<option value="${teacher}">${teacher}</option>`;
            });
            
            // Cập nhật dropdown mã lớp
            codeSelectFilter.innerHTML = '<option value="">Tất cả mã lớp</option>';
            [...codes].sort().forEach(code => {
                codeSelectFilter.innerHTML += `<option value="${code}">${code}</option>`;
            });
            
            // Thêm event listeners
            codeTeacherFilter.addEventListener('change', displayCodes);
            codeSelectFilter.addEventListener('change', displayCodes);
        }
        
        function displayCodes() {
            const container = document.getElementById('codesList');
            const searchTerm = document.getElementById('codeSearch').value.toLowerCase();
            const teacherFilter = document.getElementById('codeTeacherFilter').value;
            const codeFilter = document.getElementById('codeSelectFilter').value;
            
            // Tạo danh sách mã lớp từ tất cả các tiết
            const codes = new Set();
            scheduleData.forEach(row => {
                if (row.monday.code) codes.add(row.monday.code);
                if (row.tuesday.code) codes.add(row.tuesday.code);
                if (row.wednesday.code) codes.add(row.wednesday.code);
            });
            
            let html = '';
            [...codes].forEach(code => {
                // Áp dụng bộ lọc
                if (codeFilter && code !== codeFilter) return;
                if (!searchTerm || code.toLowerCase().includes(searchTerm)) {
                    // Tìm tất cả học sinh có mã lớp này
                    const codeStudents = [];
                    scheduleData.forEach(row => {
                        if (row.monday.code === code) {
                            codeStudents.push({
                                ...row,
                                period: 'Tiết 2',
                                subject: row.monday.subject,
                                teacher: row.monday.teacher,
                                room: row.monday.room
                            });
                        }
                        if (row.tuesday.code === code) {
                            codeStudents.push({
                                ...row,
                                period: 'Tiết 3',
                                subject: row.tuesday.subject,
                                teacher: row.tuesday.teacher,
                                room: row.tuesday.room
                            });
                        }
                        if (row.wednesday.code === code) {
                            codeStudents.push({
                                ...row,
                                period: 'Tiết 4',
                                subject: row.wednesday.subject,
                                teacher: row.wednesday.teacher,
                                room: row.wednesday.room
                            });
                        }
                    });
                    
                    const subjects = [...new Set(codeStudents.map(s => s.subject).filter(s => s))];
                    const teachers = [...new Set(codeStudents.map(s => s.teacher).filter(t => t))];
                    const rooms = [...new Set(codeStudents.map(s => s.room).filter(r => r))];
                    const periods = [...new Set(codeStudents.map(s => s.period))];
                    
                    // Lọc theo giáo viên nếu có
                    if (teacherFilter && !teachers.includes(teacherFilter)) return;
                    
                    html += `
                        <div class="student-card">
                            <div class="student-header">
                                <div class="student-info">
                                    <h3>🏷️ Mã lớp: ${code}</h3>
                                    <p>Môn: ${subjects.join(', ')} | GV: ${teachers.join(', ')} | Phòng: ${rooms.join(', ')}</p>
                                </div>
                            </div>
                            <div style="margin-top: 20px;">
                                <h4 style="color: var(--text-primary); margin-bottom: 15px;">📋 Danh sách học sinh (${codeStudents.length}):</h4>
                    `;
                    
                    // Nhóm theo tiết
                    const periodGroups = {};
                    codeStudents.forEach(student => {
                        if (!periodGroups[student.period]) {
                            periodGroups[student.period] = [];
                        }
                        periodGroups[student.period].push(student);
                    });
                    
                    Object.keys(periodGroups).forEach(period => {
                        const students = periodGroups[period];
                        html += `
                            <div style="background: var(--surface-alt); padding: 15px; margin-bottom: 15px; border-radius: 8px; border-left: 3px solid var(--primary);">
                                <h5 style="color: var(--primary); margin-bottom: 10px;">📅 ${period}</h5>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                        `;
                        
                        students.forEach((student, index) => {
                            html += `
                                <div style="background: var(--surface); padding: 10px; border-radius: 6px; border: 1px solid var(--border);">
                                    <strong>${index + 1}. ${student.studentName}</strong><br>
                                    <small style="color: var(--text-secondary);">Lớp: ${student.class}</small>
                                </div>
                            `;
                        });
                        
                        html += `
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                }
            });
            
            container.innerHTML = html || '<p>Không tìm thấy mã lớp nào.</p>';
        }
        
        function handleCodeSearch() {
            const searchTerm = document.getElementById('codeSearch').value.toLowerCase();
            const dropdown = document.getElementById('codeDropdown');
            
            if (searchTerm.length === 0) {
                dropdown.style.display = 'none';
                displayCodes();
                return;
            }
            
            const codes = new Set();
            scheduleData.forEach(row => {
                if (row.monday.code) codes.add(row.monday.code);
                if (row.tuesday.code) codes.add(row.tuesday.code);
                if (row.wednesday.code) codes.add(row.wednesday.code);
            });
            
            const filteredCodes = [...codes].filter(code => 
                code.toLowerCase().includes(searchTerm)
            );
            
            if (filteredCodes.length > 0) {
                dropdown.innerHTML = filteredCodes.map(code => 
                    `<div class="dropdown-item" onclick="selectCode('${code}')">${code}</div>`
                ).join('');
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
            
            displayCodes();
        }
        
        function selectCode(code) {
            document.getElementById('codeSearch').value = code;
            document.getElementById('codeDropdown').style.display = 'none';
            displaySelectedCode(code);
        }
        
        function displaySelectedCode(code) {
            const container = document.getElementById('codesList');
            
            // Tìm tất cả học sinh có mã lớp này
            const codeStudents = [];
            scheduleData.forEach(row => {
                if (row.monday.code === code) {
                    codeStudents.push({
                        ...row,
                        period: 'Tiết 2',
                        subject: row.monday.subject,
                        teacher: row.monday.teacher,
                        room: row.monday.room
                    });
                }
                if (row.tuesday.code === code) {
                    codeStudents.push({
                        ...row,
                        period: 'Tiết 3',
                        subject: row.tuesday.subject,
                        teacher: row.tuesday.teacher,
                        room: row.tuesday.room
                    });
                }
                if (row.wednesday.code === code) {
                    codeStudents.push({
                        ...row,
                        period: 'Tiết 4',
                        subject: row.wednesday.subject,
                        teacher: row.wednesday.teacher,
                        room: row.wednesday.room
                    });
                }
            });
            
            if (codeStudents.length === 0) {
                container.innerHTML = '<p>Không tìm thấy học sinh nào với mã lớp này.</p>';
                return;
            }
            
            const subjects = [...new Set(codeStudents.map(s => s.subject).filter(s => s))];
            const teachers = [...new Set(codeStudents.map(s => s.teacher).filter(t => t))];
            const rooms = [...new Set(codeStudents.map(s => s.room).filter(r => r))];
            
            let html = `
                <div class="student-card">
                    <div class="student-header">
                        <div class="student-info">
                            <h3>🏷️ Mã lớp: ${code}</h3>
                            <p>Môn: ${subjects.join(', ')} | GV: ${teachers.join(', ')} | Phòng: ${rooms.join(', ')}</p>
                        </div>
                    </div>
                    <div style="margin-top: 20px;">
                        <h4 style="color: var(--text-primary); margin-bottom: 15px;">📋 Danh sách học sinh (${codeStudents.length}):</h4>
            `;
            
            // Nhóm theo tiết
            const periodGroups = {};
            codeStudents.forEach(student => {
                if (!periodGroups[student.period]) {
                    periodGroups[student.period] = [];
                }
                periodGroups[student.period].push(student);
            });
            
            Object.keys(periodGroups).forEach(period => {
                const students = periodGroups[period];
                html += `
                    <div style="background: var(--surface-alt); padding: 15px; margin-bottom: 15px; border-radius: 8px; border-left: 3px solid var(--primary);">
                        <h5 style="color: var(--primary); margin-bottom: 10px;">📅 ${period}</h5>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                `;
                
                students.forEach((student, index) => {
                    html += `
                        <div style="background: var(--surface); padding: 10px; border-radius: 6px; border: 1px solid var(--border);">
                            <strong>${index + 1}. ${student.studentName}</strong><br>
                            <small style="color: var(--text-secondary);">Lớp: ${student.class}</small>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        // Các hàm in chuyên biệt - in nội dung đã lọc
        function printOverview() {
            // Lưu trạng thái hiện tại
            const currentTab = document.querySelector('.tab.active').textContent;
            
            // Chuyển sang tab tổng quan
            switchTab('all');
            
            // Đợi tab load xong rồi in
            setTimeout(() => {
                // Ẩn các phần không cần in
                hideNonPrintElements();
                
                // Thêm tiêu đề in
                addPrintHeader('Tổng Quan Thời Khóa Biểu');
                
                window.print();
                
                // Khôi phục sau khi in
                setTimeout(() => {
                    showNonPrintElements();
                    removePrintHeader();
                }, 1000);
            }, 500);
        }
        
        function printStudents() {
            // Lưu trạng thái bộ lọc hiện tại
            const classFilter = document.getElementById('studentClassFilter').value;
            const searchTerm = document.getElementById('studentSearch').value;
            
            // Chuyển sang tab học sinh
            switchTab('students');
            
            setTimeout(() => {
                hideNonPrintElements();
                
                let headerText = 'Danh Sách Học Sinh';
                if (classFilter) headerText += ` - Lớp ${classFilter}`;
                if (searchTerm) headerText += ` - Tìm kiếm: "${searchTerm}"`;
                
                addPrintHeader(headerText);
                
                window.print();
                
                setTimeout(() => {
                    showNonPrintElements();
                    removePrintHeader();
                }, 1000);
            }, 500);
        }
        
        function printTeachers() {
            const searchTerm = document.getElementById('teacherSearch').value;
            
            switchTab('teachers');
            
            setTimeout(() => {
                hideNonPrintElements();
                
                let headerText = 'Danh Sách Giáo Viên';
                if (searchTerm) headerText += ` - Tìm kiếm: "${searchTerm}"`;
                
                addPrintHeader(headerText);
                
                window.print();
                
                setTimeout(() => {
                    showNonPrintElements();
                    removePrintHeader();
                }, 1000);
            }, 500);
        }
        
        function printRooms() {
            const searchTerm = document.getElementById('roomSearch').value;
            
            switchTab('rooms');
            
            setTimeout(() => {
                hideNonPrintElements();
                
                let headerText = 'Danh Sách Phòng Học';
                if (searchTerm) headerText += ` - Tìm kiếm: "${searchTerm}"`;
                
                addPrintHeader(headerText);
                
                window.print();
                
                setTimeout(() => {
                    showNonPrintElements();
                    removePrintHeader();
                }, 1000);
            }, 500);
        }
        
        function printClasses() {
            const searchTerm = document.getElementById('classSearch').value;
            
            switchTab('classes');
            
            setTimeout(() => {
                hideNonPrintElements();
                
                let headerText = 'Danh Sách Lớp Học';
                if (searchTerm) headerText += ` - Tìm kiếm: "${searchTerm}"`;
                
                addPrintHeader(headerText);
                
                window.print();
                
                setTimeout(() => {
                    showNonPrintElements();
                    removePrintHeader();
                }, 1000);
            }, 500);
        }
        
        function printCodes() {
            const searchTerm = document.getElementById('codeSearch').value;
            const teacherFilter = document.getElementById('codeTeacherFilter').value;
            const codeFilter = document.getElementById('codeSelectFilter').value;
            
            switchTab('codes');
            
            setTimeout(() => {
                hideNonPrintElements();
                
                let headerText = 'Danh Sách Mã Lớp';
                if (teacherFilter) headerText += ` - GV: ${teacherFilter}`;
                if (codeFilter) headerText += ` - Mã: ${codeFilter}`;
                if (searchTerm) headerText += ` - Tìm kiếm: "${searchTerm}"`;
                
                addPrintHeader(headerText);
                
                window.print();
                
                setTimeout(() => {
                    showNonPrintElements();
                    removePrintHeader();
                }, 1000);
            }, 500);
        }
        
        // Hàm hỗ trợ in ấn
        function hideNonPrintElements() {
            // Ẩn các phần không cần in
            const elementsToHide = [
                '.tabs',
                '.controls', 
                '.export-section',
                '#paginationControls',
                '#paginationInfo',
                '.upload-section'
            ];
            
            elementsToHide.forEach(selector => {
                const elements = document.querySelectorAll(selector);
                elements.forEach(el => {
                    el.style.display = 'none';
                });
            });
        }
        
        function showNonPrintElements() {
            // Hiển thị lại các phần đã ẩn
            const elementsToShow = [
                '.tabs',
                '.controls', 
                '.export-section',
                '#paginationControls',
                '#paginationInfo',
                '.upload-section'
            ];
            
            elementsToShow.forEach(selector => {
                const elements = document.querySelectorAll(selector);
                elements.forEach(el => {
                    el.style.display = '';
                });
            });
        }
        
        function addPrintHeader(title) {
            const printHeader = document.createElement('div');
            printHeader.id = 'printHeader';
            printHeader.innerHTML = `
                <div style="text-align: center; margin-bottom: 30px; padding: 20px; border-bottom: 2px solid #000;">
                    <h2 style="margin: 0; font-size: 1.5rem; color: #000;">${title}</h2>
                    <p style="margin: 10px 0 0 0; color: #333; font-size: 1rem;">Ngày in: ${new Date().toLocaleDateString('vi-VN')}</p>
                </div>
            `;
            
            const scheduleContainer = document.getElementById('scheduleContainer');
            scheduleContainer.insertBefore(printHeader, scheduleContainer.firstChild);
        }
        
        function removePrintHeader() {
            const printHeader = document.getElementById('printHeader');
            if (printHeader) {
                printHeader.remove();
            }
        }
        

        
        function printSchedule() {
            window.print();
        }
        
        function showError(message) {
            errorMessage.innerHTML = `<div class="error-message">${message}</div>`;
        }
        
        function clearError() {
            errorMessage.innerHTML = '';
        }
        
        // Theme switching functionality
        function changeTheme(themeName) {
            const theme = themes[themeName];
            if (!theme) return;
            
            // Update CSS variables
            document.documentElement.style.setProperty('--primary', theme.primary);
            document.documentElement.style.setProperty('--primary-light', theme.primaryLight);
            document.documentElement.style.setProperty('--primary-dark', theme.primaryDark);
            
            // Save theme preference
            localStorage.setItem('selectedTheme', themeName);
        }
        
        // Initialize theme selector
        function initThemeSelector() {
            // Load saved theme or default to blue
            const savedTheme = localStorage.getItem('selectedTheme') || 'blue';
            changeTheme(savedTheme);
            
            // Get dropdown elements
            const dropdownSelected = document.getElementById('themeDropdownSelected');
            const dropdownOptions = document.getElementById('themeDropdownOptions');
            
            // Toggle dropdown
            dropdownSelected.addEventListener('click', (e) => {
                e.stopPropagation();
                const isOpen = dropdownOptions.classList.contains('open');
                
                if (isOpen) {
                    closeThemeDropdown();
                } else {
                    openThemeDropdown();
                }
            });
            
            // Add click event listeners to theme options
            document.querySelectorAll('.theme-dropdown-option').forEach(option => {
                option.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const themeName = option.getAttribute('data-theme');
                    selectThemeFromDropdown(themeName);
                    closeThemeDropdown();
                });
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.theme-dropdown-container')) {
                    closeThemeDropdown();
                }
            });
        }
        
        function openThemeDropdown() {
            const dropdownSelected = document.getElementById('themeDropdownSelected');
            const dropdownOptions = document.getElementById('themeDropdownOptions');
            
            dropdownSelected.classList.add('open');
            dropdownOptions.classList.add('open');
        }
        
        function closeThemeDropdown() {
            const dropdownSelected = document.getElementById('themeDropdownSelected');
            const dropdownOptions = document.getElementById('themeDropdownOptions');
            
            dropdownSelected.classList.remove('open');
            dropdownOptions.classList.remove('open');
        }
        
        function selectThemeFromDropdown(themeName) {
            const theme = themes[themeName];
            if (!theme) return;
            
            // Update selected display
            const selectedElement = document.getElementById('themeDropdownSelected');
            const colorPreview = selectedElement.querySelector('.theme-color-preview');
            const textSpan = selectedElement.querySelector('span');
            
            // Update preview and text based on theme
            const themeNames = {
                blue: 'Xanh dương',
                green: 'Xanh lá',
                purple: 'Tím',
                red: 'Đỏ',
                orange: 'Cam',
                pink: 'Hồng',
                indigo: 'Chàm',
                teal: 'Xanh ngọc'
            };
            
            const themeGradients = {
                blue: 'linear-gradient(135deg, #2563eb, #60a5fa)',
                green: 'linear-gradient(135deg, #059669, #34d399)',
                purple: 'linear-gradient(135deg, #7c3aed, #a78bfa)',
                red: 'linear-gradient(135deg, #dc2626, #f87171)',
                orange: 'linear-gradient(135deg, #ea580c, #fb923c)',
                pink: 'linear-gradient(135deg, #db2777, #f472b6)',
                indigo: 'linear-gradient(135deg, #4338ca, #818cf8)',
                teal: 'linear-gradient(135deg, #0d9488, #5eead4)'
            };
            
            colorPreview.style.background = themeGradients[themeName];
            textSpan.textContent = themeNames[themeName];
            
            // Update active state in options
            document.querySelectorAll('.theme-dropdown-option').forEach(option => {
                option.classList.remove('active');
            });
            document.querySelector(`[data-theme="${themeName}"]`).classList.add('active');
            
            // Apply theme
            changeTheme(themeName);
        }
        

    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98d4491de45bfb86',t:'MTc2MDI0Nzg2OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
